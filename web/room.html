<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.css">
    <title>Document</title>
    <style>
    body {
        background-color: #165d8f;
        padding: 30px 0;
    }
    .scrollbar::-webkit-scrollbar { 
        width:5px;
    }
    .scrollbar::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 20px;
    }
    .scrollbar::-webkit-scrollbar-thumb:hover {
        background: #f2f2f2;
    }
    .form-control:focus {
        box-shadow:none;
    }
    .content .panel {
        padding: 0;
    }
    .talks .panel-body{
        height: 500px;
        margin-left: 20px;
    }
    .message {
        background-color: #fff;
        border-radius: 5px
    }
    .message .input-group-addon {
        font-size: 30px;
    }
    .message textarea {
        height: 150px;
        border: none;
        resize: none;
        background-color: transparent;
        font-size: 20px;
    }
    #emojiList {
        display: none;
        height: 100px;
        background-color: #fff;
        padding: 0 10px;
        user-select: none;
        overflow: scroll;
    }
    #emojiList .item {
        cursor: pointer;
        font-size: 20px;
    }
    #playVideo,
    #playAudio {
        display: none;
    } 
    #userList {
        height: 450px;
        overflow: scroll;
    }
    .talks .panel-body {
        overflow: scroll;
    }
    .btn-leave {
        position: absolute;
        left: 30px;
        top: 20px;
        color: #fff;
        font-size: 30px;
        cursor: pointer;
    }
    .show {
        display: block;
    }
    .space-bottom {
        margin-bottom: 10px;
    }
    .user-list {
        position: absolute;
        right: 0;
        top: 30px;
    }
    .player .panel-body {
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 500px;
    }
    .player video {
        width: 100%;  
    }
    .musicbox {
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
        background-color: #fff;
        font-size: 0;
        padding: 5px 0;
        z-index: 2;
    }
    .musicbox audio {
        height: 0;
    }
    .musicbox progress {
        width: 100%;
        height: 2px;
        background: transparent;
    }
    .musicbox .music-info {
        font-size: 14px;
        color: #337ab7;
        font-weight: bold;
    }
    progress::-webkit-progress-bar{     
        background: transparent;
    }
    progress::-webkit-progress-value{
        background: #1885dd;
    }
    progress::-moz-progress-bar{     
        background: transparent;
    }
    progress::-moz-progress-value{
        background: #1885dd;
    }
    .music-list {
        position: fixed;
        bottom: -200px;
        left: 50%;
        width: 400px;
        height: 200px;
        transform: translateX(-200px);
        background-color: rgb(211, 211, 211);;
        transition: all ease 0.3s;
        z-index: 1;
        font-size: 16px;
        padding: 20px;
    }
    .flexbox {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    </style>
</head>
<body class="scrollbar">
    <div id="app" class="container">
        <div class="row">
            <div class="content">
                <div class="user-list panel panel-default">
                    <div class="panel-heading">用户列表</div>
                    <div class="panel-body">
                        <ul id="userList" class="list-group scrollbar"></ul>
                    </div>
                </div>
                <div class="talks panel panel-default col-xs-4">
                    <div class="panel-heading">发言列表</div>
                    <div class="panel-body scrollbar"></div>
                </div>
                <div class="player panel panel-default col-xs-8">
                    <div class="panel-heading">视频播放</div>
                    <div class="panel-body">
                        <video src="" controls autoplay></video>
                    </div>
                </div>
            </div>
            <div class="input-group message col-xs-12">
                <div class="toolbar">
                    <a class="btn">
                        <span class="glyphicon glyphicon-star btn-emoji"></span>
                    </a> 
                    <a class="btn">
                        <span class="glyphicon glyphicon-music btn-audio"></span>
                    </a>  
                    <a class="btn">
                        <span class="glyphicon glyphicon-facetime-video btn-video"></span>
                    </a>    
                </div>
                <div class="detail">
                    <div id="emojiList" class="scrollbar">
                        <span class="item">😀</span>
                        <span class="item">😁</span>
                        <span class="item">😂</span>
                        <span class="item">😃</span>
                        <span class="item">😄</span>
                        <span class="item">😅</span>
                        <span class="item">😆</span>
                        <span class="item">😉</span>
                        <span class="item">😊</span>
                        <span class="item">😋</span>
                        <span class="item">😎</span>
                        <span class="item">😍</span>
                        <span class="item">😘</span>
                        <span class="item">😗</span>
                        <span class="item">😙</span>
                        <span class="item">😚</span>
                        <span class="item">😇</span>
                        <span class="item">😐</span>
                        <span class="item">😑</span>
                        <span class="item">😶</span>
                        <span class="item">😏</span>
                        <span class="item">😣</span>
                        
                        <span class="item">😥</span>
                        <span class="item">😮</span>
                        <span class="item">😯</span>
                        <span class="item">😪</span>
                        <span class="item">😫</span>
                        <span class="item">😴</span>
                        <span class="item">😌</span>
                        <span class="item">😛</span>
                        <span class="item">😜</span>
                        <span class="item">😝</span>
                        <span class="item">😒</span>
                        <span class="item">😓</span>
                        
                        <span class="item">😔</span>
                        <span class="item">😕</span>
                        <span class="item">😲</span>
                        <span class="item">😷</span>
                        <span class="item">😖</span>
                        <span class="item">😞</span>
                        <span class="item">😟</span>
                        <span class="item">😤</span>
                        <span class="item">😢</span>
                        <span class="item">😭</span>
                        <span class="item">😦</span>
                        <span class="item">😧</span>
                        <span class="item">😨</span>
                        <span class="item">😬</span>
                        <span class="item">😰</span>
                        <span class="item">😱</span>
                        <span class="item">😳</span>
                        <span class="item">😵</span>
                        <span class="item">😡</span>
                        <span class="item">😠</span>
                    </div>
                    <div id="playAudio" class="input-group">
                        <input class="form-control" type="text" placeholder="请输入音频url">
                        <span>
                            <button class="btn btn-default" type="button">确定</button>
                        </span>
                    </div>
                    <div id="playVideo" class="input-group">
                        <input class="form-control" type="text" placeholder="请输入视频url">
                        <span>
                            <button class="btn btn-default" type="button">确定</button>
                        </span>
                    </div>
                </div>
                <textarea class="form-control scrollbar" id="textInput"></textarea>
                <span class="input-group-addon" id="submitBtn">post</span>
            </div>
        </div>
        <div class="musicbox" height="40">
            <progress max="100"></progress>
            <div class="flexbox">
                <div class="control">
                    <a id="musicPlay" class="btn glyphicon glyphicon-play"></a>
                    <a id="musicVolume" class="btn glyphicon glyphicon-volume-down"></a>
                    <a id="musicList" class="btn glyphicon glyphicon-th-list"></a>
                </div>
                <div class="music-info">正在播放：<span class="song"></span> - <span class="singer"></span></div>
            </div>
            <audio src="" controls autoplay></audio>
        </div>
        <div class="music-list scrollbar">
            <p>播放列表</p>
            <ul></ul>
        </div>
        <div class="btn btn-leave glyphicon glyphicon-menu-left" title="离开"></div>
    </div>

    <div class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body">
              <p>One fine body&hellip;</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary btn-confirm">确定</button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    
    <script src="/lib/jquery-3.4.1.min.js"></script>
    <script src="/lib/bootstrap.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    (function() {
        // 存储用户名
        let username;
        // 获取token
        let token = localStorage.getItem('token');
        if (!token) {
            location.href = './login.html';
        } 
        
        let $emojiList = $('#emojiList');
        let $emoji = $emojiList.find('.item');
        let $toolbar =  $('.toolbar');
        let $detail = $('.detail');

        let $btnPlay = $('#playVideo button');
        let $videoUrl = $('#playVideo input');
        let $player = $('.player video');
        let player = $player[0];
        let $modal = $('.modal');

        let $btnMusicList = $('#musicList');
        let $btnMusicPlay = $('#musicPlay');
        let $btnMusicVolume = $('#musicVolume');
        let $musicList = $('.music-list');
        let $btnPlayAudio = $('#playAudio button');
        let $audioUrl = $('#playAudio input');
        let $song = $('.musicbox .song');
        let $singer = $('.musicbox .singer');
        let $audio = $('.musicbox audio');
        let progress = $('.musicbox progress')[0];

        // 获取url中的参数
        let url = location.href;
        let roomId = '';
        // 存储房间信息
        let room = {};
        // 创建socket
        let socket = io();
        if (url.search('id')) {
            roomId = url.slice(url.search('id') + 3);
        }
        // 获取房间信息
        new Promise(resolve => {
            $.get('/roominfo/?id=' + roomId)
            .done(
                data => {
                    if (data.errno === 0) {
                        console.log(data);
                        room = data.data;
                        resolve()
                    } else {
                        location.href = '/index.html';
                    }
                },
                err => console.log(err)
            )
            .fail(
                err => console.log(err)
            )
        }).then(
            () => {
                // 获取用户信息
                $.get(`/userinfo?token=${token}`)
                .done(
                    data => {
                        if (data.errno === 0) {
                            username = data.data.username;
                            console.log(111, username, room.username)
                            // 获取权限
                            if (username !== room.username) {
                                $toolbar.children('a').eq(2).css({
                                    'visibility': 'hidden'
                                })
                                $player.removeAttr('controls');
                            }
                            // // 监听连接完毕
                            // socket.on('connect', () => {
                                console.log(username, roomId)
                                socket.emit('newMember', username, roomId) 
                            // })
                        }
                    },
                    err => console.log(err)
                )
                .fail(
                    err => console.log(err)
                )
            }
        )
                
        // 工具栏
        $toolbar.click(e => {
            let dom = e.target;
            let i;
            $toolbar.find('span').each((index, element) => {
                if (element === dom) {
                    i = index;
                }
            })
            
            $detail.children('div').each((index, element) => {
                if (index === i) {
                    if (element.classList.contains('show')) {
                        element.classList.remove('show');
                    } else {
                        element.classList.add('show');
                    }       
                } else {
                    element.classList.remove('show');
                }
            })  
        })
        // 表情
        Array.from($emoji).forEach(item => {
            console.log(Array.prototype.toString.call(item))
            item.onclick = function() {
                let $textInput = $('#textInput');
                $textInput.val($textInput.val() + item.innerHTML)
            }
        });
        // 视频
        $btnPlay.click(() => {
            let url = $videoUrl.val();
            $player.attr('src', url);
            $videoUrl.val("");
            let video = $player[0]
            video.onplay = function() {
                let currTime = video.currentTime;
                socket.emit('startPlay', roomId, video.src, currTime)
                video.onplay = null;
            }
        })
        // 音频
        $btnPlayAudio.click(() => {
            let url;
            if (url = $audioUrl.val()) {
                if (url.search('music.163.com')) {
                    let index = url.search('id=') + 3;
                    let id = url.substring(index);
                    new Promise(resolve => {
                        $.get(`https://api.imjad.cn/cloudmusic/?id=${id}&type=detail`)
                        .done(
                            data => {
                                resolve(data);
                            }
                        )
                    }).then(
                        data => { 
                            let duration;
                            $song.html(data.songs[0].name);
                            $singer.html(data.songs[0].ar[0].name);
                            $audio.attr('src', `https://music.163.com/song/media/outer/url?id=${id}.mp3`)

                            $audio[0].onplay = () => {
                                let currTime = $audio[0].currentTime;
                                duration = $audio[0].duration;
                                socket.emit('startPlayAudio', roomId, $audio[0].src, currTime, $song.html(), $singer.html())
                                $audio[0].onplay = null;
                                $btnMusicPlay.attr('playing', '')
                                $btnMusicPlay.removeClass('glyphicon-play').addClass('glyphicon-pause');
                            }  
                            $audio[0].ontimeupdate = () => {
                                progress.value = $audio[0].currentTime / duration * 100;
                            }
                            $audioUrl.val(""); 
                        }
                    )
                } else {
                    alert('暂不支持播放该网站的资源');
                }
            }
        })
        $btnMusicPlay.click(() => {
            if ($btnMusicPlay.attr('playing') === undefined) {
                $btnMusicPlay.attr('playing', '');
                $btnMusicPlay.removeClass('glyphicon-play').addClass('glyphicon-pause');
                $audio[0].play();
                return;
            }
            $btnMusicPlay.removeAttr('playing');
            $btnMusicPlay.removeClass('glyphicon-pause').addClass('glyphicon-play');
            $audio[0].pause();
        })
        $btnMusicVolume.click(() => {
            if ($btnMusicVolume.attr('close') === undefined) {
                $btnMusicVolume.attr('close', '')
                $btnMusicVolume.removeClass('glyphicon-volume-down').addClass('glyphicon-volume-off');
                $audio[0].volume = 0;
                return;
            }
            $btnMusicVolume.removeAttr('close');
            $btnMusicVolume.removeClass('glyphicon-volume-off').addClass('glyphicon-volume-down');
            $audio[0].volume = 1;
        })
        $btnMusicList.click(() => {
            if ($musicList.attr('show') === undefined) {
                $musicList.attr('show', '');
                $musicList.css('bottom', '46px');
                return;
            } 
            $musicList.removeAttr('show');
            $musicList.css('bottom', '-200px');
        })



 
        // 监听用户进入
        socket.on('userEnter', (id, arr, newUsername) => {
            console.log(arr);
            if (id === roomId) {
                renderUserList(arr);
            }   
            if (username === room.username && player.src != '') {
                socket.emit('currentVideo', roomId, newUsername, player.src, player.currentTime);
                socket.emit('currentAudio', roomId, newUsername, $audio[0].src, $audio[0].currentTime, $song.html(), $singer.html());
            }
        })
        // 监听用户离开
        socket.on('userLeaveRoom', (id, arr) => { 
            console.log(arr);
            if (id === roomId) {
                renderUserList(arr);
            }  
        })
        // 监听视频开始
        socket.on('videoPlayStart', (id, url, currTime) => {
            if (id === roomId && username !== room.username) {
                $player.attr('src', url);
                $player[0].currentTime = currTime;
            }
        })
        // 监听服务器发送的当前视频信息
        socket.on('videoCurrentTime', (id, name, url, currTime) => {
            if (id === roomId && name === username) {
                $player.attr('src', url);
                player.currentTime = currTime;
            }
        })
        // 监听音频开始
        socket.on('audioPlayStart', (id, url, currTime, song, singer) => {
            if (id === roomId) {
                console.log(url, currTime);
                $audio.attr('src', url);
                $audio[0].currentTime = currTime;
                $song.html(song);
                $singer.html(singer);
            }
        })
        // 监听服务器发送的当前音频信息
        socket.on('audioCurrentTime', (id, name, url, currTime, song, singer) => {
            if (id === roomId && name === username) {
                $audio.attr('src', url);
                $audio[0].currentTime = currTime;
                $song.html(song);
                $singer.html(singer);
                let duration;
                $audio[0].onplaying = () => {
                    duration = $audio[0].duration;
                    console.log(duration);
                    $audio[0].onplaying = null;
                    $btnMusicPlay.attr('playing', '')
                    $btnMusicPlay.removeClass('glyphicon-play').addClass('glyphicon-pause');
                }
                $audio[0].ontimeupdate = () => {
                    progress.value = $audio[0].currentTime / duration * 100;
                }
            }
        })

        function showModal(content) {
            $modal.modal({
                backdrop: 'static',
                keyboard: false
            });
            $modal.find('.modal-body').html(content).end().modal();       
        }
        function showModalDisband() {
            $modal.modal({
                backdrop: 'static',
                keyboard: false
            });
            $('.btn-confirm').click(e => {
                location.href = '/index.html'
            })
            $modal.find('.modal-body').html('房间已被房主解散').end().modal();
        }
        function renderUserList(arr) {
            console.log(arr)
            let list = $('#userList');
            // 清空用户列表
            list.html('');
            // 渲染用户列表
            arr.forEach(item => {
                if (room.username === item) {
                    list.append(`<li class="list-group-item"><span class="glyphicon glyphicon-home"></span>${item}</li>`)
                } else {
                    list.append(`<li class="list-group-item"><span class="glyphicon glyphicon-user"></span>${item}</li>`)
                }
            })
        }

        // 点击发言，获取内容，将内容传得给服务器，让服务器转发给每一个客户端
        let input = $('#textInput');
        $('#submitBtn').click(e => {
            // 获取内容
            let text = input.val();
            // 判断是否输入正确
            if (/^\s*$/.test(text)) {
                return alert('请输入内容')
            }
            // 提交数据
            socket.emit('message', text.trim(), roomId);
            input.val('');
        })

        // 监听showMessage消息
        socket.on('showMessage', (message, id) => {
            if (id === roomId) {
                $('.talks .panel-body').append(`<div>${message}</div>`)
            }
        })

        // 离开房间
        $('.btn-leave').click(e => {
            if (username === room.username) {
                showModal('您是房主，是否确定解散房间后离开？')
                $('.btn-confirm').click(e => {
                    $.get('/disband?id=' + roomId)
                    .done(
                        data => {
                            if (data.errno === 0) {
                                socket.emit('disband', roomId);
                                location.href = '/index.html'
                            }
                        },
                        err => console.log(err)
                    )
                    .fail(
                        err => console.log(err)
                    )
                })
            } else {
                location.href = '/index.html'
            }
        })
        socket.on('roomDisbanded', id => {
            if (roomId == id) {
                showModalDisband();
            }
        })
    })()
    </script>
</body>
</html>